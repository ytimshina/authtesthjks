<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Management System</title>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .form-section {
      display: none;
      margin-top: 30px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .required {
      color: red;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      height: 80px;
      resize: vertical;
    }
    button {
      background-color: #0078d4;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    button:hover {
      background-color: #106ebe;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    .error {
      color: red;
      margin-top: 10px;
    }
    .success {
      color: green;
      margin-top: 10px;
    }
    h1, h2, h3 {
      color: #323130;
    }
    .confirmation {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 20px;
      border-radius: 4px;
      margin-top: 20px;
    }
    .section-header {
      background-color: #f8f9fa;
      padding: 15px;
      margin: 20px 0 15px 0;
      border-left: 4px solid #0078d4;
      border-radius: 4px;
    }
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-item input[type="checkbox"] {
      width: auto;
    }
    small {
      color: #666;
      font-size: 12px;
      display: block;
      margin-top: 5px;
    }
    .hidden-field {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Employee Management System</h1>
    <p>This form automatically generates a ticket for tracking. No further actions are needed.</p>
    
    <div id="login-section">
      <button onclick="signIn()">Sign In</button>
      <button onclick="signOut()">Sign Out</button>
      <div id="output"></div>
    </div>

    <div id="form-type-section" class="form-section">
      <div class="section-header">
        <h2>Select Form Type</h2>
      </div>
      
      <div class="form-group">
        <label for="isVendor">Is this account for a vendor? <span class="required">*</span></label>
        <select id="isVendor" required onchange="handleVendorSelection()">
          <option value="">Select an option</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>

      <div class="form-group" id="formTypeGroup" style="display: none;">
        <label for="formType">Type of Form <span class="required">*</span></label>
        <select id="formType" required onchange="showSelectedForm()">
          <option value="">Select form type</option>
          <option value="new">New Employee</option>
          <option value="terminated">Terminated Employee</option>
          <option value="transfer">Internal Transfer</option>
        </select>
      </div>
    </div>

    <div id="new-employee-form" class="form-section">
      <div class="section-header">
        <h2>New Employee Form</h2>
      </div>
      
      <form id="newEmployeeForm">
        <div class="section-header">
          <h3>General Employee Information</h3>
        </div>

        <div class="form-group">
          <label for="newFirstName">First Name <span class="required">*</span></label>
          <input type="text" id="newFirstName" required>
        </div>

        <div class="form-group">
          <label for="newLastName">Last Name <span class="required">*</span></label>
          <input type="text" id="newLastName" required>
        </div>

        <div class="form-group">
          <label for="newPreferredName">Preferred First Name/Surname for Account Setup (If applicable)</label>
          <input type="text" id="newPreferredName">
        </div>

        <div class="form-group">
          <label for="newJobTitle">Employee Job Title <span class="required">*</span></label>
          <input type="text" id="newJobTitle" required>
        </div>

        <div class="form-group">
          <label for="newDepartment">Department Name <span class="required">*</span></label>
          <select id="newDepartment" required>
            <option value="">Select department</option>
            <option value="Engineering">Engineering</option>
            <option value="Manufacturing">Manufacturing</option>
            <option value="Quality">Quality</option>
            <option value="Sales">Sales</option>
            <option value="IT">IT</option>
            <option value="HR">HR</option>
            <option value="Finance">Finance</option>
          </select>
        </div>

        <div class="form-group">
          <label for="newManagerName">Manager's Name <span class="required">*</span></label>
          <input type="text" id="newManagerName" required readonly>
        </div>

        <div class="form-group">
          <label for="newPhone">Employee Mobile Phone Number <span class="required">*</span></label>
          <input type="tel" id="newPhone" placeholder="(xxx) xxx-xxxx" required>
          <small>Synoptek uses this only to contact KCC Team Member with account changes such as password</small>
        </div>

        <div class="form-group">
          <label for="newWorkLocation">Working Location <span class="required">*</span></label>
          <select id="newWorkLocation" required>
            <option value="">Select location</option>
            <option value="Kansas City">Kansas City</option>
            <option value="Remote">Remote</option>
            <option value="Field">Field</option>
          </select>
        </div>

        <div class="section-header">
          <h3>New Employee Details</h3>
        </div>

        <div class="form-group">
          <label for="newStartDate">Employee Start Date <span class="required">*</span></label>
          <input type="date" id="newStartDate" required>
        </div>

        <div class="form-group">
          <label for="newModelEmployee">Please indicate an employee to model permissions <span class="required">*</span></label>
          <select id="newModelEmployee" required>
            <option value="">Loading employees...</option>
          </select>
          <small>This means that the New Employee will have similar if not the same permissions to files and folders.</small>
        </div>

        <div class="form-group">
          <label for="newRequireEmail">Does the new hire require email? <span class="required">*</span></label>
          <select id="newRequireEmail" required>
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-group">
          <label for="newModelDL">Please indicate an employee to model Distribution Lists (DLs) <span class="required">*</span></label>
          <textarea id="newModelDL" required></textarea>
        </div>

        <div class="form-group">
          <label for="newModelSharePoint">Please indicate an employee to model SharePoint sites</label>
          <textarea id="newModelSharePoint"></textarea>
        </div>

        <div class="form-group">
          <label for="newMSLicense">Microsoft Base License Selection <span class="required">*</span></label>
          <select id="newMSLicense" required>
            <option value="">Select license type</option>
            <option value="E1">O365 E1 LIC – Outlook Webmail ONLY & Includes MS Teams</option>
            <option value="E3">O365 E3 LIC – Email, MS Teams, and Office Suite (i.e., Word, Excel, PowerPoint, Access)</option>
          </select>
          <small>*As the Hiring Manager, be selective on license type chosen based on the new hire's job responsibilities. There is an additional higher cost for an E3 license.<br>
          **For all requests for O365 E5 LIC – Email, MS Teams, Office Suite (i.e., Word, Excel, PowerPoint, Access), and Power BI Pro, reach out directly to Business Technology for the request to be approved.</small>
        </div>

        <div class="form-group">
          <label for="newTeamsPhone">Microsoft Teams Phone Licensing Option</label>
          <select id="newTeamsPhone">
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <small>*As the Hiring Manager, choose this option if the new hire's job responsibilities will include receiving inbound external calls. If Yes, there is an additional Teams Phone license that will be added to the base license for an additional cost.</small>
        </div>

        <div class="form-group">
          <label for="newDIDNumber">Direct Inbound Dialing (DID) Number Option</label>
          <select id="newDIDNumber">
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <small>The Microsoft Teams Phone licensing addition will only allow inbound calls from the outside world to be transferred from the Front Desk Operators. Outbound calls will require a DID number.</small>
        </div>

        <div class="form-group">
          <label for="newKineticAccess">Does this Employee need access to Kinetic? <span class="required">*</span></label>
          <select id="newKineticAccess" required onchange="toggleKineticFields('new')">
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-group hidden-field" id="newKineticVersionGroup">
          <label for="newKineticVersion">Which version of Kinetic access is needed?</label>
          <select id="newKineticVersion">
            <option value="">Select version</option>
            <option value="full">Full Kinetic</option>
            <option value="mes">MES</option>
            <option value="both">Both</option>
          </select>
          <small>Hiring Manager: Full version is a workstation/client installation. MES is used for clocking on the production line and other production activities.</small>
        </div>

        <div class="form-group">
          <label for="newECxAccess">Does this Employee need access to ECx Manager?</label>
          <select id="newECxAccess" onchange="toggleECxFields('new')">
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <small>ECx Manager is used for Engineering Change Management.</small>
        </div>

        <div class="form-group hidden-field" id="newECxPermissionsGroup">
          <label>What can the Employee submit in ECx Manager?</label>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="newECR" value="ECR">
              <label for="newECR">Engineering Change Requests (ECR)</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="newECO" value="ECO">
              <label for="newECO">Engineering Change Orders (ECO)</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="newECN" value="ECN">
              <label for="newECN">Engineering Change Notifications (ECN)</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="newSpecialNotes">Onboarding Process Special Notes</label>
          <textarea id="newSpecialNotes"></textarea>
        </div>

        <button type="submit">Submit New Employee Request</button>
        <button type="button" onclick="resetAllForms()">Reset Form</button>
      </form>
    </div>

    <div id="terminated-employee-form" class="form-section">
      <div class="section-header">
        <h2>Terminated Employee Form</h2>
      </div>
      
      <form id="terminatedEmployeeForm">
        <div class="form-group">
          <label for="terminatedEmployeeSelect">Select Employee to Terminate <span class="required">*</span></label>
          <select id="terminatedEmployeeSelect" required>
            <option value="">Loading employees...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="terminationDate">Employee Termination Date <span class="required">*</span></label>
          <input type="date" id="terminationDate" required>
        </div>

        <div class="form-group">
          <label for="terminatedHadEmail">Did the Terminated Employee have email? <span class="required">*</span></label>
          <select id="terminatedHadEmail" required onchange="toggleEmailForwarding()">
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-group hidden-field" id="terminatedEmailForwardingGroup">
          <label for="terminatedEmailForwarding">If the Terminated Employee has email, should it be forwarded to someone? If yes, enter that employee's name <span class="required">*</span></label>
          <input type="text" id="terminatedEmailForwarding" placeholder="Enter employee name or leave blank if no forwarding needed">
        </div>

        <div class="form-group hidden-field" id="terminatedEmailAliasGroup">
          <label for="terminatedEmailAliasRemoval">If the Terminated Employee has their email setup as a message alias, please indicate a date to remove</label>
          <input type="date" id="terminatedEmailAliasRemoval">
        </div>

        <div class="form-group">
          <label for="terminatedDeviceCollected">Was the KCC end user device collected? <span class="required">*</span></label>
          <select id="terminatedDeviceCollected" required onchange="toggleDeviceReason()">
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-group hidden-field" id="terminatedDeviceReasonGroup">
          <label for="terminatedDeviceReason">Why wasn't it collected? <span class="required">*</span></label>
          <input type="text" id="terminatedDeviceReason" placeholder="Explain why device was not collected">
        </div>

        <div class="form-group">
          <label for="terminatedPhoneTransfer">Did the Terminated Employee have a company phone number they would like to transfer to a new carrier? <span class="required">*</span></label>
          <select id="terminatedPhoneTransfer" required>
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <small>*Phone stipends are automatically removed when the Terminated Employee is removed from Paycor.</small>
        </div>

        <div class="form-group">
          <label for="terminatedKineticAccount">Does the Terminated Employee have a Kinetic account to disable? <span class="required">*</span></label>
          <select id="terminatedKineticAccount" required>
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-group">
          <label for="terminatedECxAccess">Does this Employee have access to ECx Manager to remove?</label>
          <select id="terminatedECxAccess">
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-group">
          <label for="terminatedSpecialNotes">Offboarding Process Special Notes</label>
          <textarea id="terminatedSpecialNotes" placeholder="Enter any special notes or instructions for the offboarding process"></textarea>
        </div>

        <button type="submit">Submit Termination Request</button>
        <button type="button" onclick="resetAllForms()">Reset Form</button>
      </form>
    </div>

    <div id="transfer-form" class="form-section">
      <div class="section-header">
        <h2>Internal Employee Transfer Form</h2>
      </div>
      
      <form id="transferForm">
        <div class="form-group">
          <label for="transferEmployeeSelect">Select Employee to Transfer <span class="required">*</span></label>
          <select id="transferEmployeeSelect" required>
            <option value="">Loading employees...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="transferDate">Employee Transfer Date <span class="required">*</span></label>
          <input type="date" id="transferDate" required>
          <small>As listed in HR</small>
        </div>

        <div class="form-group">
          <label for="transferWorkLocation">Employee Transfer Updated Work Location <span class="required">*</span></label>
          <select id="transferWorkLocation" required>
            <option value="">Select location</option>
            <option value="Kansas City">Kansas City</option>
            <option value="Remote">Remote</option>
            <option value="Field">Field</option>
          </select>
        </div>

        <div class="form-group">
          <label for="transferBadgeAccess">Did you notify HR to update the Transferred Employee's access badge access? <span class="required">*</span></label>
          <select id="transferBadgeAccess" required>
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <small>This could include access levels as well as locations depending on his or her new role.</small>
        </div>

        <div class="form-group">
          <label for="transferEmailMaintain">Should the Transferred Employee email account be maintained, or should it be forwarded to someone? <span class="required">*</span></label>
          <input type="text" id="transferEmailMaintain" placeholder="Enter 'maintain' or employee name to forward to" required>
        </div>

        <div class="form-group">
          <label for="transferEmailAliasRemoval">If the Transferred Employee has their email account setup as a message alias, please indicate a date to remove <span class="required">*</span></label>
          <input type="date" id="transferEmailAliasRemoval" required>
          <small>We will pay for this email account while it remains active.</small>
        </div>

        <div class="form-group">
          <label for="transferDeviceRepurpose">Does the Transferred Employee have a company owned device that needs to be repurposed? <span class="required">*</span></label>
          <select id="transferDeviceRepurpose" required>
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <small>Example: Position change from a non-Engineering position to requiring an Engineering level laptop.</small>
        </div>

        <div class="form-group">
          <label for="transferModelEmployee">Which employee should be used to mimic company owned device setup and network access? <span class="required">*</span></label>
          <select id="transferModelEmployee" required>
            <option value="">Loading employees...</option>
          </select>
          <small>This means that the transferred employee will have similar if, not the same permissions to files and folders, as the supplied employee.</small>
        </div>

        <div class="form-group">
          <label for="transferPhoneNumber">Did the Transferred Employee have a company phone number they would like to transfer to a new carrier? <span class="required">*</span></label>
          <select id="transferPhoneNumber" required>
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-group">
          <label for="transferKineticUser">Which current Kinetic users permissions can be mirrored for this transferred employee?</label>
          <input type="text" id="transferKineticUser" placeholder="Enter employee name">
          <small>Hiring Manager: This would be the name of an employee that performs the same function.</small>
        </div>

        <div class="form-group">
          <label for="transferECxAccess">Does this Employee need access to ECx Manager? <span class="required">*</span></label>
          <select id="transferECxAccess" required onchange="toggleECxFields('transfer')">
            <option value="">Select an option</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
          <small>ECx Manager is used for Engineering Change Management.</small>
        </div>

        <div class="form-group hidden-field" id="transferECxPermissionsGroup">
          <label>What can the Employee submit in ECx Manager?</label>
          <div class="checkbox-group">
            <div class="checkbox-item">
              <input type="checkbox" id="transferECR" value="ECR">
              <label for="transferECR">Engineering Change Requests (ECR)</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="transferECO" value="ECO">
              <label for="transferECO">Engineering Change Orders (ECO)</label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="transferECN" value="ECN">
              <label for="transferECN">Engineering Change Notifications (ECN)</label>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="transferSpecialNotes">Transfer Process Special Notes</label>
          <textarea id="transferSpecialNotes"></textarea>
        </div>

        <button type="submit">Submit Transfer Request</button>
        <button type="button" onclick="resetAllForms()">Reset Form</button>
      </form>
    </div>

    <div id="confirmation-section" style="display: none;">
      <div class="confirmation">
        <h2>✓ Request Submitted Successfully</h2>
        <p><strong>Thank you!</strong> Your <span id="conf-form-type"></span> request has been submitted and a ticket has been automatically generated for tracking.</p>
        <div id="conf-details"></div>
        <p><strong>Submitted by:</strong> <span id="conf-manager"></span></p>
        <p>No further actions are needed at this time. The IT team will process this request and handle all necessary account changes and system access modifications.</p>
        <button onclick="submitAnother()">Submit Another Request</button>
      </div>
    </div>

    <div id="vendor-redirect" style="display: none;">
      <div class="confirmation">
        <h2>Vendor Access Request</h2>
        <p>For vendor access requests, please use the dedicated vendor form:</p>
        <a href="https://forms.office.com/r/4de9ChLZX3" target="_blank" style="color: #0078d4; text-decoration: none; font-weight: bold;">
          Technical Needs - Vendor Access Request Form
        </a>
        <br><br>
        <button onclick="goBack()">Go Back</button>
      </div>
    </div>
  </div>

  <script>
    let msalInstance;
    let currentAccount;
    let allEmployees = [];

    window.addEventListener('DOMContentLoaded', () => {
      const msalConfig = {
        auth: {
          clientId: "8f3f4c99-7fc0-4dd7-8038-07a335b0d7ac",
          authority: "https://login.microsoftonline.com/36ac54bd-4aec-4920-8680-85a46915b905",
          redirectUri: "https://ytimshina.github.io/authtesthjks/"
        }
      };
      msalInstance = new msal.PublicClientApplication(msalConfig);
    });
    
    window.signIn = async function () {
      try {
        const loginResponse = await msalInstance.loginPopup({
          scopes: ["user.read", "user.read.all", "directory.read.all"]
        });
        currentAccount = loginResponse.account;
        document.getElementById("output").innerText = `Hello, ${currentAccount.username}`;
        
        await loadAllEmployees();
        document.getElementById('form-type-section').style.display = 'block';
        
      } catch (error) {
        console.error(error);
        document.getElementById("output").innerText = `Login failed: ${error.message}`;
      }
    };

    // ===========================
    // MISSING FUNCTIONS - FIXED
    // ===========================
    
    window.signOut = async function () {
      try {
        if (currentAccount) {
          await msalInstance.logoutPopup({
            account: currentAccount
          });
        }
        currentAccount = null;
        document.getElementById("output").innerText = "Signed out successfully";
        
        // Hide form sections when signing out
        document.getElementById('form-type-section').style.display = 'none';
        hideAllForms();
        
        // Reset form selections
        document.getElementById('isVendor').value = '';
        document.getElementById('formType').value = '';
        document.getElementById('formTypeGroup').style.display = 'none';
        
      } catch (error) {
        console.error('Sign out error:', error);
        document.getElementById("output").innerText = `Sign out failed: ${error.message}`;
      }
    };

    window.resetAllForms = function () {
      // Reset all form elements
      const forms = ['newEmployeeForm', 'terminatedEmployeeForm', 'transferForm'];
      forms.forEach(formId => {
        const form = document.getElementById(formId);
        if (form) {
          form.reset();
        }
      });
      
      // Reset form type selection
      document.getElementById('isVendor').value = '';
      document.getElementById('formType').value = '';
      document.getElementById('formTypeGroup').style.display = 'none';
      
      // Hide all conditional fields
      const hiddenFields = document.querySelectorAll('.form-group');
      hiddenFields.forEach(field => {
        if (field.id && (field.id.includes('VersionGroup') || field.id.includes('PermissionsGroup') || 
            field.id.includes('ForwardingGroup') || field.id.includes('AliasGroup') || 
            field.id.includes('ReasonGroup'))) {
          field.classList.add('hidden-field');
        }
      });
      
      // Re-populate manager name if signed in
      if (currentAccount) {
        loadAllEmployees();
      }
      
      // Clear any success/error messages
      document.getElementById("output").innerHTML = document.getElementById("output").innerHTML.split('<div')[0];
    };

    window.submitAnother = function () {
      // Hide confirmation section
      document.getElementById('confirmation-section').style.display = 'none';
      
      // Show form type selection
      document.getElementById('form-type-section').style.display = 'block';
      
      // Reset all forms
      resetAllForms();
    };

    window.goBack = function () {
      // Hide vendor redirect
      document.getElementById('vendor-redirect').style.display = 'none';
      
      // Show form type selection
      document.getElementById('form-type-section').style.display = 'block';
      
      // Reset vendor selection
      document.getElementById('isVendor').value = '';
      document.getElementById('formTypeGroup').style.display = 'none';
    };

    // ===========================
    // EXISTING FUNCTIONS
    // ===========================

    async function loadAllEmployees() {
      try {
        const tokenResponse = await msalInstance.acquireTokenSilent({
          scopes: ["user.read.all", "directory.read.all"],
          account: currentAccount
        });

        // Get manager's direct reports
        const directReportsResponse = await fetch('https://graph.microsoft.com/v1.0/me/directReports', {
          headers: {
            'Authorization': `Bearer ${tokenResponse.accessToken}`,
            'Content-Type': 'application/json'
          }
        });

        // Get current user info for manager name
        const currentUserResponse = await fetch('https://graph.microsoft.com/v1.0/me', {
          headers: {
            'Authorization': `Bearer ${tokenResponse.accessToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (directReportsResponse.ok && currentUserResponse.ok) {
          const directReports = await directReportsResponse.json();
          const currentUser = await currentUserResponse.json();
          
          allEmployees = directReports.value;
          
          // Auto-populate manager name in new employee form
          document.getElementById('newManagerName').value = currentUser.displayName;
          
          populateEmployeeDropdowns();
        }
        
      } catch (error) {
        console.error('Error loading employees:', error);
        document.getElementById('output').innerHTML += `<div class="error">Error loading employees: ${error.message}</div>`;
      }
    }

    function populateEmployeeDropdowns() {
      const selects = [
        'terminatedEmployeeSelect', 
        'transferEmployeeSelect', 
        'newModelEmployee', 
        'transferModelEmployee'
      ];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.innerHTML = '<option value="">Select an employee</option>';
          
          if (allEmployees.length === 0) {
            select.innerHTML = '<option value="">No employees found</option>';
          } else {
            allEmployees.forEach(employee => {
              const option = document.createElement('option');
              option.value = JSON.stringify({
                id: employee.id,
                displayName: employee.displayName,
                mail: employee.mail || employee.userPrincipalName,
                jobTitle: employee.jobTitle || '',
                department: employee.department || ''
              });
              option.textContent = `${employee.displayName} (${employee.mail || employee.userPrincipalName})`;
              select.appendChild(option);
            });
          }
        }
      });
    }

    function handleVendorSelection() {
      const isVendor = document.getElementById('isVendor').value;
      const formTypeGroup = document.getElementById('formTypeGroup');
      const vendorRedirect = document.getElementById('vendor-redirect');
      
      if (isVendor === 'yes') {
        formTypeGroup.style.display = 'none';
        vendorRedirect.style.display = 'block';
        hideAllForms();
      } else if (isVendor === 'no') {
        formTypeGroup.style.display = 'block';
        vendorRedirect.style.display = 'none';
      } else {
        formTypeGroup.style.display = 'none';
        vendorRedirect.style.display = 'none';
      }
    }

    function showSelectedForm() {
      const formType = document.getElementById('formType').value;
      hideAllForms();
      
      switch(formType) {
        case 'new':
          document.getElementById('new-employee-form').style.display = 'block';
          break;
        case 'terminated':
          document.getElementById('terminated-employee-form').style.display = 'block';
          break;
        case 'transfer':
          document.getElementById('transfer-form').style.display = 'block';
          break;
      }
    }

    function hideAllForms() {
      document.getElementById('new-employee-form').style.display = 'none';
      document.getElementById('terminated-employee-form').style.display = 'none';
      document.getElementById('transfer-form').style.display = 'none';
      document.getElementById('confirmation-section').style.display = 'none';
    }

    function toggleKineticFields(formType) {
      const kineticAccess = document.getElementById(formType + 'KineticAccess').value;
      const versionGroup = document.getElementById(formType + 'KineticVersionGroup');
      
      if (kineticAccess === 'yes' && versionGroup) {
        versionGroup.classList.remove('hidden-field');
      } else if (versionGroup) {
        versionGroup.classList.add('hidden-field');
      }
    }

    function toggleECxFields(formType) {
      const ecxAccess = document.getElementById(formType + 'ECxAccess').value;
      const permissionsGroup = document.getElementById(formType + 'ECxPermissionsGroup');
      
      if (ecxAccess === 'yes' && permissionsGroup) {
        permissionsGroup.classList.remove('hidden-field');
      } else if (permissionsGroup) {
        permissionsGroup.classList.add('hidden-field');
      }
    }

    function toggleEmailForwarding() {
      const hadEmail = document.getElementById('terminatedHadEmail').value;
      const emailGroup = document.getElementById('terminatedEmailForwardingGroup');
      const aliasGroup = document.getElementById('terminatedEmailAliasGroup');
      
      if (hadEmail === 'yes') {
        emailGroup.classList.remove('hidden-field');
        aliasGroup.classList.remove('hidden-field');
      } else {
        emailGroup.classList.add('hidden-field');
        aliasGroup.classList.add('hidden-field');
      }
    }

    function toggleDeviceReason() {
      const deviceCollected = document.getElementById('terminatedDeviceCollected').value;
      const reasonGroup = document.getElementById('terminatedDeviceReasonGroup');
      
      if (deviceCollected === 'no') {
        reasonGroup.classList.remove('hidden-field');
      } else {
        reasonGroup.classList.add('hidden-field');
      }
    }

    // ===================================================================
    // == Event listener for the Terminated Employee Form ==
    // ===================================================================
    document.getElementById('terminatedEmployeeForm').addEventListener('submit', async function(event) {
        event.preventDefault(); // Prevent the default browser form submission action

        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';

        const outputDiv = document.getElementById('output');
        outputDiv.innerHTML = ''; // Clear previous success/error messages

        try {
            // 1. Get the selected employee's data from the dropdown
            const employeeSelect = document.getElementById('terminatedEmployeeSelect');
            if (!employeeSelect.value) {
                throw new Error('Please select an employee to terminate.');
            }
            const selectedEmployee = JSON.parse(employeeSelect.value);
            const employeeEmail = selectedEmployee.mail;

            if (!employeeEmail) {
                throw new Error('The selected employee does not have a valid email address.');
            }

            // 2. Construct the API URL with the email as a query parameter
            // The email is URL-encoded to handle special characters safely
            const apiUrl = `https://ab251b24a8b8.ngrok-free.app/api/Employee/disable?email=${encodeURIComponent(employeeEmail)}`;

            // 3. Send the POST request to the API
            console.log(`Sending POST request to: ${apiUrl}`); // For debugging

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'accept': '*/*', // As specified in your curl example
                },
                // No body is needed for this request
            });

            // 4. Check if the API call was successful
            if (response.ok) {
                console.log('API call successful. Employee disabled.');
                outputDiv.innerHTML = `<div class="success">Termination request for ${selectedEmployee.displayName} was submitted successfully.</div>`;
                // Optionally, hide the form and show the confirmation section
                hideAllForms();
                document.getElementById('confirmation-section').style.display = 'block';
                document.getElementById('conf-form-type').textContent = 'Termination';
                document.getElementById('conf-manager').textContent = currentAccount.username;
                document.getElementById('conf-details').innerHTML = `<p><strong>Terminated Employee:</strong> ${selectedEmployee.displayName}</p>`;

            } else {
                // If the server responded with an error status (e.g., 404, 500)
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText || 'Failed to submit termination.'}`);
            }

        } catch (error) {
            // Handle errors from the fetch call (e.g., network error) or thrown errors
            console.error('Termination submission failed:', error);
            outputDiv.innerHTML = `<div class="error">An error occurred: ${error.message}</div>`;
        } finally {
            // Re-enable the submit button regardless of success or failure
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Termination Request';
        }
    });

    // ===================================================================
    // == Event listeners for New Employee and Transfer Forms ==
    // ===================================================================
    document.getElementById('newEmployeeForm').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const selectedEmployee = document.getElementById('newModelEmployee').value ? 
            JSON.parse(document.getElementById('newModelEmployee').value) : null;
        
        // Show confirmation
        hideAllForms();
        document.getElementById('confirmation-section').style.display = 'block';
        document.getElementById('conf-form-type').textContent = 'New Employee';
        document.getElementById('conf-manager').textContent = currentAccount.username;
        document.getElementById('conf-details').innerHTML = `
            <p><strong>New Employee:</strong> ${document.getElementById('newFirstName').value} ${document.getElementById('newLastName').value}</p>
            <p><strong>Department:</strong> ${document.getElementById('newDepartment').value}</p>
            <p><strong>Start Date:</strong> ${document.getElementById('newStartDate').value}</p>
        `;
    });

    document.getElementById('transferForm').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const selectedEmployee = document.getElementById('transferEmployeeSelect').value ? 
            JSON.parse(document.getElementById('transferEmployeeSelect').value) : null;
        
        // Show confirmation
        hideAllForms();
        document.getElementById('confirmation-section').style.display = 'block';
        document.getElementById('conf-form-type').textContent = 'Transfer';
        document.getElementById('conf-manager').textContent = currentAccount.username;
        document.getElementById('conf-details').innerHTML = `
            <p><strong>Transferred Employee:</strong> ${selectedEmployee ? selectedEmployee.displayName : 'Unknown'}</p>
            <p><strong>Transfer Date:</strong> ${document.getElementById('transferDate').value}</p>
            <p><strong>New Location:</strong> ${document.getElementById('transferWorkLocation').value}</p>
        `;
    });

  </script>
</body>
</html>
