<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MSAL Auth Test - Fixed</title>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
</head>
<body>
  <h1>Microsoft Login Test</h1>
  <button onclick="signIn()">Sign In</button>
  <button onclick="signOut()">Sign Out</button>
  <button onclick="getManagerInfoWithConsent()" id="managerBtn" style="display:none;">Get Manager Info</button>
  <div id="output"></div>
  <div id="manager-info"></div>
  <script>
    // Ensure MSAL is available before using it
    window.addEventListener('DOMContentLoaded', () => {
      const msalConfig = {
        auth: {
          clientId: "8f3f4c99-7fc0-4dd7-8038-07a335b0d7ac",
          authority: "https://login.microsoftonline.com/36ac54bd-4aec-4920-8680-85a46915b905",
          
          redirectUri: "https://ytimshina.github.io/authtesthjks/"
        }
      };
      const msalInstance = new msal.PublicClientApplication(msalConfig);
      
      window.signIn = async function () {
        try {
          const loginResponse = await msalInstance.loginPopup({
            scopes: ["user.read"]
          });
          const account = loginResponse.account;
          document.getElementById("output").innerText = `Hello, ${account.username}`;
          
          // Try to get manager info with basic permissions first
          await tryManagerInfoBasic(account);
          
        } catch (error) {
          console.error(error);
          document.getElementById("output").innerText = `Login failed: ${error.message}`;
        }
      };
      
      window.tryManagerInfoBasic = async function(account) {
        try {
          // Try with basic user.read token first
          const tokenResponse = await msalInstance.acquireTokenSilent({
            scopes: ["user.read"],
            account: account
          });
          
          const response = await fetch('https://graph.microsoft.com/v1.0/me/manager', {
            headers: {
              'Authorization': `Bearer ${tokenResponse.accessToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const manager = await response.json();
            document.getElementById("manager-info").innerHTML = `
              <h3>Manager Information:</h3>
              <p><strong>Name:</strong> ${manager.displayName || 'N/A'}</p>
              <p><strong>Email:</strong> ${manager.mail || manager.userPrincipalName || 'N/A'}</p>
              <p><strong>Job Title:</strong> ${manager.jobTitle || 'N/A'}</p>
              <p><strong>Department:</strong> ${manager.department || 'N/A'}</p>
            `;
            // Hide the manager button since we got the info
            document.getElementById("managerBtn").style.display = 'none';
          } else {
            // If basic permissions don't work, show the button for elevated permissions
            document.getElementById("managerBtn").style.display = 'inline-block';
          }
        } catch (error) {
          // If basic approach fails, show the button for elevated permissions
          document.getElementById("managerBtn").style.display = 'inline-block';
        }
      };
      
      window.getManagerInfoWithConsent = async function() {
        try {
          const account = msalInstance.getAllAccounts()[0];
          
          // Request additional permissions specifically for manager info
          const tokenResponse = await msalInstance.acquireTokenPopup({
            scopes: ["User.Read.All", "Directory.Read.All"],
            account: account
          });
          
          // Call Microsoft Graph API to get manager info
          const response = await fetch('https://graph.microsoft.com/v1.0/me/manager', {
            headers: {
              'Authorization': `Bearer ${tokenResponse.accessToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const manager = await response.json();
            document.getElementById("manager-info").innerHTML = `
              <h3>Manager Information:</h3>
              <p><strong>Name:</strong> ${manager.displayName || 'N/A'}</p>
              <p><strong>Email:</strong> ${manager.mail || manager.userPrincipalName || 'N/A'}</p>
              <p><strong>Job Title:</strong> ${manager.jobTitle || 'N/A'}</p>
              <p><strong>Department:</strong> ${manager.department || 'N/A'}</p>
              <p><strong>Office Location:</strong> ${manager.officeLocation || 'N/A'}</p>
              <p><strong>Phone:</strong> ${manager.businessPhones?.[0] || 'N/A'}</p>
            `;
          } else if (response.status === 404) {
            document.getElementById("manager-info").innerHTML = `
              <h3>Manager Information:</h3>
              <p>No manager found in the directory.</p>
            `;
          } else {
            const errorText = await response.text();
            console.error('API Error:', response.status, errorText);
            document.getElementById("manager-info").innerHTML = `
              <h3>Manager Information:</h3>
              <p>Error loading manager information: HTTP ${response.status}</p>
            `;
          }
        } catch (error) {
          console.error('Error fetching manager info:', error);
          document.getElementById("manager-info").innerHTML = `
            <h3>Manager Information:</h3>
            <p>Error loading manager information: ${error.message}</p>
          `;
        }
      };
      
      window.signOut = function () {
        const account = msalInstance.getAllAccounts()[0];
        if (account) {
          msalInstance.logoutPopup({
            account: account
          });
          // Clear displayed information and hide manager button
          document.getElementById("output").innerText = '';
          document.getElementById("manager-info").innerHTML = '';
          document.getElementById("managerBtn").style.display = 'none';
        }
      };
    });
  </script>
</body>
</html>
